# C_2 ProblemCreate Page REQUIREMENTS

## 機能要件
- 生成フローの単一ページ化
  - ページ遷移なしで以下の3つのフェーズを切り替える。
    1. 生成開始 (Generation Start)
    2. 構造確定 (Structure Confirmed)
    3. 生成完了 (Generation Completed)
- プログレスバー（進捗表示）
  - 画面上部に常時進捗を表示。
- トグルによる生成元の切り替え
  - Toggle Label: `[ 演習問題から生成 | 資料から生成 ]`
  - トグルに応じて、アップロード後の設定オプション内容が完全に切り替わる。
- フェーズごとのUI構成とコンポーネント分割
  1. **生成開始フェーズ**
     - プログレスバー
     - トグルスイッチ: `[ 演習問題から生成 | 資料から生成 ]`
     - アップロードエリア（FileUploadBlock）
     - 生成元別オプションエリア（ExerciseOptions / DocumentOptions）
       - ※このオプション部分は生成元によってロジックが異なるため、別コンポーネントとしてファイルを分けること。
       - **共通項目**:
         - 図表を使用 (Checkbox, Default: ON)
         - 問題構造を確認 (Checkbox, Default: OFF)
         - 生成問題を公開 (Checkbox, Default: OFF)
       - **演習問題から生成 限定項目**:
         - 難易度 (Select: 自動判別[Default], 基礎, 標準, 応用, 難関)
       - **資料から生成 限定項目**:
         - 難易度 (Select: 自動判別[Default], 基礎, 標準, 応用, 難関)
         - 問題数 (Input/Slider: Default 10, Range 5-20)
         - 問題形式 (Checkbox Group):
           - 「自動設定」チェックボックス (Default: ON)
           - OFF時にアコーディオン展開: 個別指定（記述式、選択式、穴埋め式、正誤判定、数値計算式、証明問題、プログラミング、コード読解）の複数選択
  2. **構造解析フェーズ**
     - `ProblemViewEditPage` のコンポーネントを再利用し、メタデータ・構造・キーワードを編集。
  3. **生成完了かフェーズ**
     - `ProblemViewEditPage` の機能をフルに使用し、問題本文や解答まで含めて編集。

## 画面レイアウト（図形式）

### 1. 生成開始 (Generation Start)
```text
┌──────────────────────────────────────────────────────────────┐
│ TopMenuBar (Provided by App.tsx)                             │
├──────────────────────────────────────────────────────────────┤
│ Progress Bar: [生成開始] ── 構造解析 ── 生成完了                 │
├──────────────────────────────────────────────────────────────┤
│ Toggle: [ 演習問題から生成 | 資料から生成 ]                      │
├──────────────────────────────────────────────────────────────┤
│ File Upload Block                                            │
│ (Drag & Drop area)                                           │
├──────────────────────────────────────────────────────────────┤
│ Type-specific Options Block (Dynamic component)              │
│ (DocumentOptions.tsx or ExerciseOptions.tsx)                 │
└──────────────────────────────────────────────────────────────┘
```


### 1.5. 問題構造を解析中 (Problem Structure Parsing)
```text
┌──────────────────────────────────────────────────────────────┐
│ TopMenuBar (Provided by App.tsx)                             │
├──────────────────────────────────────────────────────────────┤
│ Progress Bar: 生成開始 [──] 構造解析 ── 生成完了                 │
├──────────────────────────────────────────────────────────────┤
│ 問題構造を解析中                                              │
└──────────────────────────────────────────────────────────────┘
```




### 2. 構造確定 (Structure Confirmed)
```text
┌──────────────────────────────────────────────────────────────┐
│ TopMenuBar (Provided by App.tsx)                             │
├──────────────────────────────────────────────────────────────┤
│ Progress Bar: 生成開始 ── [構造解析] ── 生成完了                 │
├──────────────────────────────────────────────────────────────┤
## 構造イメージ（閲覧モード）
```
[問題情報 Metadata]
  - タイトル / 科目・年度 / 大学 /
[大問ブロック #1]
  ├─ Header: 大問番号 / 難易度 / 大問キーワード（チップ複数）
  └─ 小問ブロック群
       [小問 #1]
         - Header: 小問番号 / 問題形式 / 小問キーワード（チップ複数）
       [小問 #2] ...（同上）

[大問ブロック #2] ... （以降繰り返し）



## 構造イメージ（編集モード）

[問題情報 Metadata エディタ]
  - タイトル、科目、年度、大学
  - アクションバー: プレビュー切替 / 保存 / 取消

[大問ブロック エディタ #1]
  ├─ Headerフォーム: 大問番号（必須） / 難易度 / 大問キーワード（チップ追加・削除）
  └─ 小問ブロックエディタ群
       [小問エディタ #1]
         - Headerフォーム: 小問番号 / 問題形式 / キーワード（チップ追加・削除）
       [小問エディタ #2] ...（同上）

[大問ブロック追加/削除]
  - 大問の追加 / 移動 / 削除
  - 小問の追加 / 移動 / 削除
```



### 2.5 演習問題を生成中 (Generating Exercise)
```text
┌──────────────────────────────────────────────────────────────┐
│ TopMenuBar (Provided by App.tsx)                             │
├──────────────────────────────────────────────────────────────┤
│ Progress Bar: 生成開始 ── 構造解析 [──] 生成完了                 │
├──────────────────────────────────────────────────────────────┤
│ 演習問題を生成中 (Generating Exercise)                         │
└──────────────────────────────────────────────────────────────┘
```


### 3. 生成完了 (Generation Completed)
```text
┌──────────────────────────────────────────────────────────────┐
│ TopMenuBar (Provided by App.tsx)                             │
├──────────────────────────────────────────────────────────────┤
│ Progress Bar: 生成開始 ── 構造解析 ── [生成完了]                 │
├──────────────────────────────────────────────────────────────┤
## 構造イメージ（閲覧モード）
[問題情報 Metadata]
  - タイトル / 科目・年度 / 大学 /

[大問ブロック #1]
  ├─ Header: 大問番号 / 難易度 / 大問キーワード（チップ複数）
  ├─ 大問の問題文（Markdown+LaTeX）
  └─ 小問ブロック群
       [小問 #1]
         - Header: 小問番号 / 問題形式 / 小問キーワード（チップ複数）
         - 小問の問題文
         - 解答・解説（折りたたみ可能）
       [小問 #2] ...（同上）

[大問ブロック #2] ... （以降繰り返し）

```

## 構造イメージ（編集モード）
```
[問題情報 Metadata エディタ]
  - タイトル、科目、年度、大学、作成者などのフォーム
  - 公開設定 / ステータス / 閲覧数系は表示のみ（編集不可）
  - アクションバー: プレビュー切替 / 保存 / 取消

[大問ブロック エディタ #1]
  ├─ Headerフォーム: 大問番号（必須） / 難易度 / 大問キーワード（チップ追加・削除）
  ├─ 大問問題文エディタ（Markdown対応テキストエリア）
  └─ 小問ブロックエディタ群
       [小問エディタ #1]
         - Headerフォーム: 小問番号 / 問題形式 / キーワード（チップ追加・削除）
         - 小問問題文エディタ
         - 解答・解説エディタ
         - 解答折りたたみ設定・表示切替
       [小問エディタ #2] ...（同上）

[大問ブロック追加/削除]
  - 大問の追加 / 移動 / 削除
  - 小問の追加 / 移動 / 削除
```



## 実装上の注意
- **モジュール化の徹底**: `ProblemCreatePage.tsx` にコンポーネントや重いロジックを直接記述しない。
  - サブコンポーネントは `src/components/page/ProblemCreatePage/` フォルダへ配置。
  - フックやロジックは `src/pages/ProblemCreatePage/hooks/` 等へ配置。
- **無駄なレンダリングの抑制**: プログレスバーなどの「不変ブロック」は再レンダリングを避け、変更が必要なコンテンツエリアのみを更新する。
- **コンポーネントの再利用**: `ProblemViewEditPage` 由来のコンポーネント（Meta/Question/Answer等）を積極的に再利用し、一貫したエディタ体験を提供すること。

## レイヤー規格（z-indexと重なり順の統一ルール）
- 目的: トップバーより前面に通常コンテンツがかぶる等の不具合を防ぎ、全ページで一貫した重なり順を維持する。
- スケール定義:
  - 900台: グローバルオーバーレイ層（999: モーダル最前面、950: ドロワー/全画面メニュー、930: Toast/ポップアップ）
  - 800台: ナビ層（899: TopMenuBar、850: サブナビ/固定タブ）
  - 700台: ページ上位コンテナ（750: ページ固有ヘッダー/ステップバー）
  - 600台: 固定補助（650: 固定サイド/追従カード）
  - 500台: 通常コンテンツ（カード/フォーム。原則 z-index 指定なし）
  - 400台: 背景演出（装飾用のみ）
- 運用ルール:
  - z-index は必要最小限。レイヤー種別に合わせ固定値を使い、props で自由な値を受け取らない。
  - ドロップダウン/ツールチップ/ポップオーバーはポータルルートで z-930 に統一。
  - モーダル/ドロワーは Overlay z-950、Content z-999 の固定パターンを採用。
  - TopMenuBar は常に z-899、ページ固有ヘッダー/進捗バーは z-750 以内、通常カードは z 指定なし。
  - transform/filter/backdrop-filter による不要なスタッキングコンテキスト生成を避ける。
  - 新規コンポーネントが z-index を要する場合、上記スケールから選び、レビュー時に種別を明記する。
